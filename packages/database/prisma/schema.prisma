generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Item {
  id          String                                                                                                                                                                                                                                                                                                                         @id @default(uuid())
  name        String
  description String
  createdAt   DateTime                                                                                                                                                                                                                                                                                                                       @default(now())
  updatedAt   DateTime                                                                                                                                                                                                                                                                                                                       @updatedAt
  latestPrice Int
  link        String
  brandId     String
  materialId  String?
  gender      Gender?
  deletedAt   DateTime?
  inTrash     Boolean                                                                                                                                                                                                                                                                                                                        @default(false)
  isSoldOut   Boolean                                                                                                                                                                                                                                                                                                                        @default(false)
  status      ItemStatus                                                                                                                                                                                                                                                                                                                     @default(ACTIVE)
  search_tsv  Unsupported("tsvector GENERATED ALWAYS AS (setweight(to_tsvector('english', mask_unstemmable_words(coalesce(name, ''))), 'A') || setweight(to_tsvector('english', mask_unstemmable_words(coalesce(description, ''))), 'D') || setweight(to_tsvector('english', extract_last_path_segment(coalesce(link, ''))), 'C')) STORED")?
  categories  CategoryItem[]
  images      Image[]
  brand       Brand                                                                                                                                                                                                                                                                                                                          @relation(fields: [brandId], references: [id])
  material    Material?                                                                                                                                                                                                                                                                                                                      @relation(fields: [materialId], references: [id])
  carts       ItemCart[]
  orders      ItemOrder[]
  views       ItemView[]
  likes       Like[]
  prices      Price[]
  sizes       Size[]
  colors      Color[]                                                                                                                                                                                                                                                                                                                        @relation("ColorToItem")

  @@index([search_tsv], map: "idx_items_search_tsv", type: Gin)
  @@index([brandId])
  @@index([materialId])
  @@index([inTrash])
}

model GuestUser {
  id            String         @id @default(uuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  brandFollows  BrandFollow[]
  brandViews    BrandView[]
  categoryViews CategoryView[]
  itemCarts     ItemCart[]
  itemViews     ItemView[]
  likes         Like[]
  sessions      Session[]

  @@index([createdAt])
}

model Session {
  id          String    @id @default(uuid())
  guestUserId String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  isExpired   Boolean   @default(false)
  GuestUser   GuestUser @relation(fields: [guestUserId], references: [id])

  @@index([guestUserId])
}

model ItemView {
  id          String     @id @default(uuid())
  userId      String?
  itemId      String
  createdAt   DateTime   @default(now())
  quantity    Int        @default(1)
  updatedAt   DateTime   @updatedAt
  guestUserId String?
  deletedAt   DateTime?
  GuestUser   GuestUser? @relation(fields: [guestUserId], references: [id])
  item        Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@index([itemId])
  @@index([userId])
  @@index([guestUserId])
}

model CategoryView {
  id          String     @id @default(uuid())
  userId      String?
  categoryId  String
  createdAt   DateTime   @default(now())
  quantity    Int        @default(1)
  updatedAt   DateTime   @updatedAt
  guestUserId String?
  category    Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  GuestUser   GuestUser? @relation(fields: [guestUserId], references: [id])
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([userId])
  @@index([guestUserId])
}

model BrandView {
  id          String     @id @default(uuid())
  userId      String?
  brandId     String
  createdAt   DateTime   @default(now())
  quantity    Int        @default(1)
  updatedAt   DateTime   @updatedAt
  guestUserId String?
  brand       Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  GuestUser   GuestUser? @relation(fields: [guestUserId], references: [id])
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([userId])
  @@index([guestUserId])
}

model BrandFollow {
  id          String     @id @default(uuid())
  userId      String?
  brandId     String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  guestUserId String?
  brand       Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  GuestUser   GuestUser? @relation(fields: [guestUserId], references: [id])
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@unique([guestUserId, brandId])
  @@index([userId])
  @@index([brandId])
  @@index([guestUserId])
}

model Like {
  id          String     @id @default(uuid())
  userId      String?
  itemId      String
  createdAt   DateTime   @default(now())
  guestUserId String?
  GuestUser   GuestUser? @relation(fields: [guestUserId], references: [id])
  item        Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@unique([guestUserId, itemId])
  @@index([itemId])
  @@index([userId])
}

model Price {
  id        String   @id @default(uuid())
  price     Int
  createdAt DateTime @default(now())
  itemId    String
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId, createdAt(sort: Desc)])
}

model Brand {
  id                   String             @id @default(uuid())
  name                 String             @unique
  description          String?
  image                String?
  logo                 String?
  inTrash              Boolean            @default(false)
  createdAt            DateTime           @default(now())
  isPartnerBrand       Boolean            @default(false)
  updatedAt            DateTime           @default(now()) @updatedAt
  label                String?
  commissionPercentage Int?
  keywords             String[]
  deletedAt            DateTime?
  categoryId           String?
  category             Category?          @relation("CategoryToBrand", fields: [categoryId], references: [id], onDelete: Cascade)
  restrictedCategoryId String?
  restrictedCategory   Category?          @relation("RestrictedCategoryToBrand", fields: [restrictedCategoryId], references: [id], onDelete: Cascade)
  gender               Gender?
  brandFollows         BrandFollow[]
  brandViews           BrandView[]
  items                Item[]
  ShippingEstimate     ShippingEstimate[]
  showrooms            Showroom[]         @relation("BrandToShowroom")

  @@index([deletedAt])
}

model Showroom {
  id     String  @id @default(uuid())
  name   String
  brands Brand[] @relation("BrandToShowroom")
}

model Category {
  id               String         @id @default(uuid())
  name             String
  createdAt        DateTime       @default(now())
  deletedAt        DateTime?
  description      String?
  gender           Gender?
  isDefault        Boolean        @default(false)
  keywords         String[]
  kidsImage        String?
  label            String?
  level            Int            @default(3)
  menImage         String?
  parentId         String?
  slug             String?        @unique
  updatedAt        DateTime       @default(now()) @updatedAt
  womenImage       String?
  parent           Category?      @relation("ParentCategory", fields: [parentId], references: [id])
  children         Category[]     @relation("ParentCategory")
  items            CategoryItem[]
  CategoryView     CategoryView[]
  brands           Brand[]        @relation("CategoryToBrand")
  restrictedBrands Brand[]        @relation("RestrictedCategoryToBrand")
  inTrash          Boolean        @default(false)

  @@index([deletedAt])
}

model CategoryItem {
  id         String      @id @default(uuid())
  categoryId String
  itemId     String
  score      Float?
  status     LabelStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  category   Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  item       Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([categoryId])
}

model Color {
  id         String      @id @default(uuid())
  name       String
  itemCarts  ItemCart[]
  itemOrders ItemOrder[]
  items      Item[]      @relation("ColorToItem")
}

model Image {
  id          String   @id @default(uuid())
  url         String
  itemId      String
  createdAt   DateTime @default(now())
  isThumbnail Boolean  @default(false)
  Item        Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model Size {
  id         String      @id @default(uuid())
  name       String
  itemId     String
  available  Boolean     @default(true)
  createdAt  DateTime    @default(now())
  itemCarts  ItemCart[]
  itemOrders ItemOrder[]
  Item       Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
}

model Material {
  id    String @id @default(uuid())
  name  String
  items Item[]
}

model Applicant {
  id        String          @id @default(uuid())
  name      String
  email     String
  phone     String
  createdAt DateTime        @default(now())
  whyLoom   String
  whyYou    String
  status    ApplicantStatus @default(PENDING)
}

model Newsletter {
  id        String         @id @default(uuid())
  email     String
  type      NewsletterType @default(NEWSLETTER)
  createdAt DateTime       @default(now())
}

model Trash {
  id   String @id @default(uuid())
  link String
}

model User {
  id                       String         @id @default(uuid())
  email                    String         @unique
  password                 String
  username                 String         @unique
  isEmailConfirmed         Boolean        @default(false)
  phoneNumber              String
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  firstName                String?
  lastName                 String?
  confirmationToken        String?
  tokenExpiresAt           DateTime?
  isPasswordReset          Boolean        @default(true)
  isOnboardingLoginAllowed Boolean        @default(false)
  customMessage            String?
  addresses                Address[]
  brandFollows             BrandFollow[]
  brandViews               BrandView[]
  categoryViews            CategoryView[]
  itemCarts                ItemCart[]
  itemViews                ItemView[]
  likes                    Like[]
  orders                   Order[]

  @@index([email])
}

model ItemCart {
  id              String     @id @default(uuid())
  itemId          String
  quantity        Int        @default(1)
  sizeId          String
  colorId         String?
  userId          String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  guestUserId     String?
  deletedAt       DateTime?
  isSavedForLater Boolean    @default(false)
  color           Color?     @relation(fields: [colorId], references: [id])
  GuestUser       GuestUser? @relation(fields: [guestUserId], references: [id])
  item            Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  size            Size       @relation(fields: [sizeId], references: [id])
  user            User?      @relation(fields: [userId], references: [id])

  @@index([deletedAt])
  @@index([itemId])
  @@index([userId])
  @@index([guestUserId])
}

model Order {
  id                String             @id @default(uuid())
  orderNumber       String             @unique
  orderTotal        Int
  status            OrderStatus        @default(PENDING)
  userId            String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  email             String
  phoneNumber       String
  addressId         String
  items             ItemOrder[]
  address           Address            @relation(fields: [addressId], references: [id])
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingEstimates ShippingEstimate[]

  @@index([orderNumber, status])
}

model ItemOrder {
  id                 String           @id @default(uuid())
  orderId            String
  itemId             String
  quantity           Int              @default(1)
  name               String
  image              String
  price              Int
  sizeId             String
  colorId            String?
  shippingEstimateId String
  color              Color?           @relation(fields: [colorId], references: [id])
  item               Item             @relation(fields: [itemId], references: [id])
  order              Order            @relation(fields: [orderId], references: [id])
  shippingEstimate   ShippingEstimate @relation(fields: [shippingEstimateId], references: [id], onDelete: Cascade)
  size               Size             @relation(fields: [sizeId], references: [id])
}

model Address {
  id          String      @id @default(uuid())
  firstName   String
  lastName    String
  company     String?
  address     String
  apartment   String?
  city        String
  governorate String
  country     String      @default("Egypt")
  postalCode  String?
  createdAt   DateTime    @default(now())
  userId      String
  addressType AddressType @default(NORMAL)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders      Order[]
}

model ShippingEstimate {
  id         String      @id @default(uuid())
  cost       Int
  brandId    String
  orderId    String
  itemOrders ItemOrder[]
  brand      Brand       @relation(fields: [brandId], references: [id])
  order      Order       @relation(fields: [orderId], references: [id])
}

enum Gender {
  MALE
  FEMALE
  UNISEX
  KIDS
}

enum ItemStatus {
  DELETED
  IN_TRASH
  ACTIVE
}

enum LabelStatus {
  PENDING
  AUTO_LABEL
  MANUAL_LABEL
}

enum ApplicantStatus {
  PENDING
  EMAIL_SENT
  ONLINE_INTERVIEW_SCHEDULED
  ONLINE_INTERVIEW_COMPLETED
  IN_PERSON_INTERVIEW_SCHEDULED
  IN_PERSON_INTERVIEW_COMPLETED
  HIRED
  REJECTED
}

enum NewsletterType {
  CAREERS
  NEWSLETTER
}

enum AddressType {
  NORMAL
  BILLING
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

